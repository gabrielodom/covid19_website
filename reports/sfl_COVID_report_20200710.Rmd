---
title: "South Florida COVID-19 Trajectory"
author: "Roy Williams, Gabriel J. Odom, Zoran Bursac, and Mary Jo Trepka"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```




# Introduction
**This is a special issue of the Miami COVID-19 Project Trajectory Report including Palm Beach and Broward Counties with data including June 30th, 2020. This report will be updated at the authors' convenience.**

Public understanding of science is critical in times of crisis. The following analysis was conducted to examine the trajectory of COVID-19 in the South Florida counties of Miami-Dade, Broward, and Palm Beach. For phased reopening, the White House has set guidelines for local municipalities in their “Opening Up American Again” report. In the report, it is highly suggested that:

1. Local areas show a downward trajectory in the number of positive cases as a percent of total tests over a two-week period, and
2. Local hospitals have capacity to handle all patients without crisis care.

The analysis begins by looking at the number of new positive cases each day and the number of total tests performed each day. The figures are presented together because **as there is more testing, there are likely to be more positive test results**. Therefore, the proportion of positive cases is also calculated. Given a flat or increasing number of tests performed, **the proportion of positive cases is the key metric to be used when looking at epidemic trajectory**. It is recommended that this proportion <ins>not exceed</ins> 5%.

Finally, to ensure hospitals can meet demand without crisis care, the COVID-19 positive hospitalization census, COVID-19 positive ICU census, and COVID-19 positive ventilation census is plotted over time. Census refers to the number of COVID-19 positive patients in the hospital, ICU, and on ventilators, respectively, on a given day.

For Miami-Dade, Broward, and Palm Beach Counties, this document shows the

- Full testing counts data,
- Count of positive and total COVID-19 tests since mid-March,
- Proportion of positive counts to total counts within the last two weeks,
- Proportion of positive counts to total counts since mid-March,
- Full COVID-19 hospitalization census data, and
- Counts of patients hospitalized with COVID-19 since the beginning of April


<!-- Include code to setup and import data here: -->
```{r packages}
library(tidyverse)
library(lubridate)
library(cowplot)
library(kableExtra)
```

```{r import_ESS_data}
# Raw data import and wrangling script sfl_COVID_report_wrangleESS_20200625.R
#   in covid19_sfl_website/southFL_covid19_website/code/

# Gabriel's Machine:
southFloridaHospitalised_df <- 
	read_csv(
		file = "../../data/ESS_southFL_summary_20200709.csv"
	)

# Roy's Machine:
# southFloridaHospitalised_df <- 
# 	read_csv(
# 		file = "ESS_southFL_summary_20200630.csv"
# 	)

startEndESS_date <- 
	southFloridaHospitalised_df %>%
	slice(1, n()) %>%
	pull(Date) 
```


*******************************************************************************




# Miami-Dade County


## COVID-19 Testing Data
```{r md_read_data}
# Gabriel's Machine:
mdCases_df <- read_csv(
	file = "../../data/FLDH_COVID19_cases_miamidade_20200709.csv"
) 

# Roy's Machine:
# mdCases_df <- read_csv(
# 	file = "Miami Overall 628.csv"
# )

mdCases_df <- 
	mdCases_df %>% 
	mutate(PropPositive = 100 * Positive / (Positive + Negative)) %>% 
	mutate(PositivePer1k = (PropPositive / 100) * 1000)
```

```{r md_fix_dates}
mdCases2_df <- 
	mdCases_df %>% 
	mutate(Date = as.POSIXct(strptime(Date, format = "%d-%b"))) %>% 
	mutate(Date = as_date(Date)) 

startEnd_date <- 
	mdCases2_df %>%
	slice(1, n()) %>%
	pull(Date) %>%
	format("%d %B")
```

```{r md_recent_data}
mdRecent_df <- 
	mdCases2_df %>% 
	top_n(15, Date)

# Date Range
recentStartEnd_date <- 
	mdRecent_df %>%
	slice(1, n()) %>%
	pull(Date) %>%
	format("%d %B")

# Recent Linear Trend Slope for Total Counts
mdRecentTCountSlope_num <-
	mdRecent_df %>% 
	lm(Positive + Negative ~ Date, data = .) %>% 
	coefficients() %>% 
	pluck(2)

# Recent Linear Trend Slope for Positive Counts
mdRecentPCountSlope_num <-
	mdRecent_df %>% 
	lm(Positive ~ Date, data = .) %>% 
	coefficients() %>% 
	pluck(2)

# Doubling Time for Positive Counts
# We first find the number of Expected Positives per 1k; that is, if we tested
#   1k people each day, how many would be positive that day? What is the rate
#   of increase of this standardised positive count over the past two weeks?
mdRecentPosPer1kSlope_num <-
	mdRecent_df %>% 
	lm(PositivePer1k ~ Date, data = .) %>% 
	coefficients() %>% 
	pluck(2)
# That means that the number of new cases per day is increasing by 5 people per
#   thousand. So not only are we constantly adding new cases (about 150 new
#   cases per thousand per day), we are increasing that number by 5 per day.
# What about total cases?
mdRecent2_df <- 
	mdRecent_df %>% 
	mutate(TotalNewCases = cumsum(PositivePer1k))
mdRecentCasesAddedPer1kPerDay <-
	mdRecent2_df %>% 
	lm(TotalNewCases ~ Date, data = .) %>% 
	coefficients() %>% 
	pluck(2)
# Yep, about 150 new cases each day. Doubling time?
casesMinMax <- range(mdRecent2_df$TotalNewCases)
# 70 / (diff(casesMinMax) / casesMinMax[1])

# Recent Linear Trend Slope for Proportion
mdRecentSlope_num <-
	mdRecent_df %>% 
	lm(PropPositive ~ Date, data = .) %>% 
	coefficients() %>% 
	pluck(2)

# Slope Adjective:
mdAdjective <- case_when(
	abs(mdRecentSlope_num) < 0.1 ~ "slight",
	abs(mdRecentSlope_num) < 0.5 ~ "",
	abs(mdRecentSlope_num) > 0.5 ~ "significant"
)
```

### Full Data
This is a table of the most recent data we have available. We include data sources at the end of the document.
```{r}
knitr::kable(mdCases_df) %>% 
	kable_styling() %>%
  scroll_box(height = "500px")
```

</br>

### Total COVID-19 Tests by Day
The average number of COVID-19 tests performed each day has doubled from about 2,000 in early April to just under 10,000 in late June. Over the past two weeks, there has been an average increase of `r round(mdRecentTCountSlope_num)` new additional tests each day, per day in Miami-Dade County. This data is presented on a log scale.

```{r md_tests_over_time}
nTotal_gg <- 
	ggplot(
		data = mdCases2_df %>%
			mutate(Total = Positive + Negative)
	) +
	
	theme_bw() +
	theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
	aes(x = Date, y = Total) + 
	scale_y_log10(
		breaks = c(2000, 5000, 10000),
		labels = c("2k", "5k", "10k")
	) +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	labs(
		title = "Number of COVID-19 Tests by Day",
		subtitle = paste(
			"Miami-Dade County;",
			startEnd_date[1], "to", startEnd_date[2], "2020"
		),
		y = "Counts (Log10 Scale)"
	) +
	
	stat_smooth(method = "loess", colour = "black") +
  geom_point(colour = "black")

nTotal_gg
```

### Positive COVID-19 Tests by Day
There was a general decrease in the number of new positive test results from early April until around mid May when Miami-Dade reopened. Afterwards, this trend flattened out and then increased. Over the past two weeks, there has been an average increase of `r round(mdRecentPCountSlope_num)` new additional positive cases each day, per day in Miami-Dade County. **A high of 2447 for new positive cases was obtained on July 3rd.**

```{r md_cases_over_time}
nPositive_gg <- 
	ggplot(data = mdCases2_df) +
	
	theme_bw() +
	theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
	aes(x = Date, y = Positive) + 
	# scale_y_log10() +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	labs(
		title = "Number of Positive COVID-19 Tests Results by Day",
		subtitle = paste(
			"Miami-Dade County;",
			startEnd_date[1], "to", startEnd_date[2], "2020"
		)
	) + 
	
	stat_smooth(method = "loess", colour = "green") +
	geom_point(colour = "green") 

nPositive_gg
```

### Proportion of Positive Cases within Past Two Weeks 
During the 14-day period from `r recentStartEnd_date[1]` to `r recentStartEnd_date[2]`, there was a <b> `r mdAdjective` `r if (mdRecentSlope_num > 0) "increase" else "decrease"` </b> in the proportion of positive COVID-19 cases reported in Miami-Dade County. Over this period, there was an average increase of `r round(mdRecentSlope_num, 1)` percentage points per day for new positive cases. This increase was even greater during the last week. Given a flat or increasing number of tests performed, the proportion of positive tests obtained is the **key metric** for examining COVID-19 trajectory. **The percentage of positive test results obtained has exceeded the 5% positive threshold recommended by the World Health Organization (WHO) for reopening.**

```{r md_recent_proportion}
# Plot
ggplot(data = mdRecent_df) +
	
	theme_bw() +
	aes(x = Date, y = PropPositive) +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	labs(
		title = "Proportion of Positive Test Results within the Past Two Weeks",
		subtitle = paste(
			"Miami-Dade County;",
			recentStartEnd_date[1], "to", recentStartEnd_date[2],
			"2020; Linear Change =",
			round(mdRecentSlope_num, 3)
		),
		caption = "Solid line: LOESS Predictor; Dashed line: Linear Predictor.",
		y = "Proportion (%) of Positive Cases"
	) +
	
	geom_point() +
	stat_smooth(method = "loess", colour = "black") +
	stat_smooth(method = "lm", colour = "black", se = FALSE, linetype = "dashed")
```

### Proportion of Positive COVID-19 Tests by Day
Overall, the proportion of positive test results out of all tests **decreased significantly** from just under 20% in early April to the proportion of about 5% at the end of May. This is function of test availability and the population being tested. Overall, since the county reopened, the proportion of positive tests is now **increasing significantly** over time, returning to the current proportion of approximately 20%. Given a flat or increasing number of tests performed, an increase in the proportion of positive tests obtained points to evidence of increased COVID-19 community spread in Miami-Dade county.

```{r md_prop_over_time_full}
ggplot(data = mdCases2_df) +
	
	theme_bw() +
	theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
	aes(x = Date, y = PropPositive) +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	labs(
		title = "Overall Proportion of Positive Test Results Out of All Tests",
		subtitle = paste(
			"Miami-Dade County;",
			startEnd_date[1], "to", startEnd_date[2], "2020"
		),
		caption = "Solid line: LOESS Predictor; Red Triangle at Phase 1 Reopening",
		y = "Proportion (%) of Positive Cases"
	) +
	
	geom_point() +
	stat_smooth(method = "loess", colour = "orange") + 
	geom_point(
		data = tibble(
			Date = as_date("2020-05-18"),
			y = 0
		),
		aes(x = Date, y = y),
		pch = 24, size = 2, fill = "red"
	)
```



## COVID-19 Hospitalization Data

### Full Data
```{r md_hosp_data}
miamidadeHospitalised_df <- 
	southFloridaHospitalised_df %>% 
	filter(County == "MIAMI-DADE")

miamidadeHospitalised_df[
	miamidadeHospitalised_df$Date == "2020-06-04",
	"Ventilated"
] <- NA_real_
# There is an error in the original data for June 4th. Rather than deleting the
#   whole row of the raw data, we are skipping this ventilation value

miamidadeCOVID_df <-
	miamidadeHospitalised_df %>%
	select(-County, -AdmitPrevDay, -DischPrevDay, -DeltaAdmit) %>% 
	pivot_longer(
		Hospitalized:Ventilated,
		names_to = "Type",
		values_to = "Count"
	)
```

The data below is COVID-19 hospital census data for Miami-Dade County for all dates with available data since April 2.These columns are: the number of patients hospitalized with COVID-19 (**Hospitalized**), the number of patients in intensive care with COVID-19 (**ICU**), the number of patients in intensive care with COVID-19 who are also on ventilators (**Ventilated**), the number of patients positive for COVID-19 that were admitted the previous day (**AdmitPrevDay**), the number of patients recovered from COVID-19 that were discharged the previous day (**DischPrevDay**), and the net admission of patients positive for COVID-19 the previous day (**DeltaAdmit**; a negative value means more recovered patients were discharged than sick patients admitted).

```{r md_print_hosp_data}
miamidadeHospitalised_df %>% 
  knitr::kable() %>% 
	kable_styling() %>%
  scroll_box(height = "500px")
```

</br>


### Hospital COVID-19 Census Trajectory
We now show a census plot of hospitalizations, patients in ICU, and those in ICU on ventilators (shown on a log scale) for Miami-Dade County. Overall, since mid-April, the number of COVID-19 positive patients in Miami-Dade County hospitals remained constant at around 700 people in hospitals until mid June. The COVID-19 ICU census has decreased from its reported peak of 285 on April 17th to around 100 as of June 6th. Overall, the number of COVID-19 patients on ventilators has decreased significantly from its highest point of 192 ventilated on April 22nd to around 60 on June 6th. **However, the observed decreasing trends for ICU census and ventilation census have reversed over the past three weeks and begun to increase for both ICU census and ventilation census, respectively.** Additionally, county hospitalizations have begun to increase as well. On June 30th, 1219 COVID-19 positive patients were hospitalized, a new high during the period analyzed

```{r md_graph_hosp_counts, warning = FALSE}
ggplot(data = miamidadeCOVID_df) +

	theme_bw() +
	theme(
		axis.text.x = element_text(angle = 45, hjust = 1),
		legend.position = "bottom"
	) +
	aes(x = Date, y = Count, group = Type, colour = Type) +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	scale_y_log10() +
	scale_color_manual(
		values = c(
			"Ventilated" = "#ff0000",
			"ICU" = "#ff7400",
			"Hospitalized" = "#ffc100"
		)
	) +
	labs(
		title = "Overall Miami-Dade County Hospital COVID-19 Census",
		subtitle = paste(
			"Miami-Dade County;",
			format(startEndESS_date[1], "%d %B"),
			"to",
			format(startEndESS_date[2], "%d %B"),
			"2020"
		),
		y = "Counts (Log10 Scale)"
	) +

	geom_point(size = 2) +
	stat_smooth(se = FALSE)
```

We also show the proportion of patients hospitalized which are in ICU and the proportion of those in ICU which are ventilated.
```{r md_ICU_vent_props, warning=FALSE}
ggplot(
	data = miamidadeHospitalised_df %>% 
		mutate(PctICU = 100 * ICU / Hospitalized) %>% 
		mutate(PctVentICU = 100 * Ventilated / ICU) %>% 
		select(Date, PctICU, PctVentICU) %>% 
		pivot_longer(
		PctICU:PctVentICU,
		names_to = "Type",
		values_to = "Proportion"
	)
) + 
	
	theme_bw() +
	theme(
		axis.text.x = element_text(angle = 45, hjust = 1),
		legend.position = "bottom"
	) +
	aes(x = Date, y = Proportion, group = Type, colour = Type) +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	scale_color_manual(
		labels = c("In ICU", "In ICU on Ventilators"),
		values = c(
			"PctVentICU" = "#ff0000",
			"PctICU" = "#ff7400"
		)
	) +
	labs(
		title = "Miami-Dade County Hospital Percent in ICU and Ventilated",
		subtitle = paste(
			"Miami-Dade County;",
			format(startEndESS_date[1], "%d %B"),
			"to",
			format(startEndESS_date[2], "%d %B"),
			"2020"
		),
		caption = 
			"% of Patients Hospitalized with COVID-19 who are in ICU (orange)\n % of Patients in ICU with COVID-19 who are on ventilators (red)",
		y = "Proportions"
	) +

	geom_point(size = 2) +
	stat_smooth(se = FALSE)
```

Overall, the percentage of COVID-19 hospitalized patients requiring intensive care has decreased from over 40% in early April to around 13% in mid May. In the past three weeks, this trend has reversed and the percentage of patients in the ICU on ventilation has begun to increase to approximately 25%. Additionally, the percentage of patients in the ICU on ventilation has decreased from approximately 85% in early April to the current percentage of under 50%. This decrease has continued over the past three weeks.


*******************************************************************************




# Broward County


## COVID-19 Testing Data
```{r brow_read_data}
browCases_df <- read_csv(
	file = "../../data/FLDH_COVID19_cases_broward_20200709.csv"
) %>% 
	mutate(PropPositive = 100 * Positive / (Positive + Negative)) %>% 
	mutate(PositivePer1k = (PropPositive / 100) * 1000) %>% 
	# Crazy outlier on the 8th of April; drop it
	filter(Date != "8-Apr")
```

```{r brow_fix_dates}
browCases2_df <- 
	browCases_df %>% 
	mutate(Date = as.POSIXct(strptime(Date, format = "%d-%b"))) %>% 
	mutate(Date = as_date(Date)) 
```

```{r brow_recent_data}
browRecent_df <- 
	browCases2_df %>% 
	top_n(15, Date)

# Recent Linear Trend Slope for Total Counts
browRecentTCountSlope_num <-
	browRecent_df %>% 
	lm(Positive + Negative ~ Date, data = .) %>% 
	coefficients() %>% 
	pluck(2)

# Recent Linear Trend Slope for Positive Counts
browRecentPCountSlope_num <-
	browRecent_df %>% 
	lm(Positive ~ Date, data = .) %>% 
	coefficients() %>% 
	pluck(2)

# Recent Linear Trend Slope
browRecentSlope_num <-
	browRecent_df %>% 
	lm(PropPositive ~ Date, data = .) %>% 
	coefficients() %>% 
	pluck(2)

# Slope Adjective:
browAdjective <- case_when(
	abs(browRecentSlope_num) < 0.1 ~ "slight",
	abs(browRecentSlope_num) < 0.5 ~ "",
	abs(browRecentSlope_num) > 0.5 ~ "significant"
)
```

### Full Data
```{r}
knitr::kable(browCases_df) %>% 
	kable_styling() %>%
  scroll_box(height = "500px")
```

</br>


### Total COVID-19 Tests by Day
The average number of COVID-19 tests performed each day has increased from about 1000 in early April to approximately 5000 in late June. Over the past two weeks, there has been an average increase of `r round(browRecentTCountSlope_num)` new additional tests each day in Broward County. This data is presented on a log scale.

```{r brow_tests_over_time, warning=FALSE}
nTotal_gg <- 
	ggplot(
		data = browCases2_df %>%
			mutate(Total = Positive + Negative)
	) +
	
	theme_bw() +
	theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
	aes(x = Date, y = Total) + 
	scale_y_log10(
		breaks = c(2000, 5000, 10000),
		labels = c("2k", "5k", "10k")
	) +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	labs(
		title = "Number of COVID-19 Tests by Day",
		subtitle = paste(
			"Broward County;",
			startEnd_date[1], "to", startEnd_date[2], "2020"
		),
		y = "Counts (Log10 Scale)"
	) +
	
	stat_smooth(method = "loess", colour = "black") +
  geom_point(colour = "black")

nTotal_gg
```

### Positive COVID-19 Tests by Day
There was a general decrease in the number of new positive test results from early April until around May 11th. Afterwards, this trend flattened out and then increased. Over the past two weeks, there has been an average increase of `r round(browRecentPCountSlope_num)` new additional positive cases each day, per day in Broward County.

```{r brow_cases_over_time, warning=FALSE}
nPositive_gg <- 
	ggplot(data = browCases2_df) +
	
	theme_bw() +
	theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
	aes(x = Date, y = Positive) + 
	# scale_y_log10() +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	labs(
		title = "Number of Positive COVID-19 Tests Results by Day",
		subtitle = paste(
			"Broward County;",
			startEnd_date[1], "to", startEnd_date[2], "2020"
		)
	) + 
	
	stat_smooth(method = "loess", colour = "green") +
	geom_point(colour = "green") 

nPositive_gg
```

### Proportion of Positive Cases within Past Two Weeks
During the 14-day period from `r recentStartEnd_date[1]` to `r recentStartEnd_date[2]`, there was a <b> `r browAdjective` `r if (browRecentSlope_num > 0) "increase" else "decrease"` </b> in the proportion of positive COVID-19 cases reported in Broward County. Over this period, there was an average increase of `r round(browRecentSlope_num, 1)` percentage points per day for new positive cases.

```{r brow_recent_proportion}
# Plot
ggplot(data = browRecent_df) +
	
	theme_bw() +
	aes(x = Date, y = PropPositive) +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	labs(
		title = "Proportion of Positive Test Results within the Past Two Weeks",
		subtitle = paste(
			"Broward County;",
			recentStartEnd_date[1], "to", recentStartEnd_date[2],
			"2020; Linear Change =",
			round(browRecentSlope_num, 3)
		),
		caption = "Solid line: LOESS Predictor; Dashed line: Linear Predictor.",
		y = "Proportion (%) of Positive Cases"
	) +
	
	geom_point() +
	stat_smooth(method = "loess", colour = "black") +
	stat_smooth(method = "lm", colour = "black", se = FALSE, linetype = "dashed")
```

### Proportion of Positive COVID-19 Tests by Day
Overall, the proportion of positive test results out of all tests decreased significantly from over 15% in April to the proportion of about 4% at the end of May. **From there, there has been an increase to the currently proportion of over 15%.** This measure is a function of test availability and the population being tested. Overall, since the county reopened, the proportion of positive tests is now **increasing significantly** over time. Over the past two weeks, the proportion of positive cases obtained has increased by approximately `r round(browRecentSlope_num, 1)` % each day for Broward County.

```{r brow_prop_over_time_full, warning=FALSE}
ggplot(data = browCases2_df) +
	
	theme_bw() +
	theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
	aes(x = Date, y = PropPositive) +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	labs(
		title = "Overall Proportion of Positive Test Results Out of All Tests",
		subtitle = paste(
			"Broward County;",
			startEnd_date[1], "to", startEnd_date[2], "2020"
		),
		caption = "Solid line: LOESS Predictor",
		y = "Proportion (%) of Positive Cases"
	) +
	
	geom_point() +
	stat_smooth(method = "loess", colour = "orange")
```


## COVID-19 Hospitalization Data
```{r brow_hosp_data}
browardHospitalised_df <- 
	southFloridaHospitalised_df %>% 
	filter(County == "BROWARD")

browardCOVID_df <-
	browardHospitalised_df %>%
	select(-County, -AdmitPrevDay, -DischPrevDay, -DeltaAdmit) %>% 
	pivot_longer(
		Hospitalized:Ventilated,
		names_to = "Type",
		values_to = "Count"
	)
```

### Full Data
```{r brow_print_hosp_data}
browardHospitalised_df %>% 
  knitr::kable() %>% 
	kable_styling() %>%
  scroll_box(height = "500px")
```

</br>


### Hospital COVID-19 Census Trajectory
We now show a census plot of hospitalizations, patients in ICU, and those in ICU on ventilators (shown on a log scale) for Broward County. Overall, in Broward County, hospitalizations and ICU census trended downwards until approximately the first week of June. Subsequently, these trends reversed and now trend upwards. The trend for ventilation has increased over approximately the past two weeks. The COVID-19 ICU census had decreased from its reported peak of 147 on April 16th to a minimum of 41 on May 16th; currently, it has increased back to `r browardHospitalised_df$ICU[nrow(browardHospitalised_df)]`. **The observed decreasing trends for ICU census has reversed over the past month and began to increase.** Overall, the number of COVID-19 patients in ICU on ventilators has decreased significantly from its highest point of 121 ventilated on April 12th to a minimum of 23 on May 13th; currently, there are `r browardHospitalised_df$Ventilated[nrow(browardHospitalised_df)]` patients on ventilators in ICU. Additionally, county hospitalizations have begun to increase over the past three weeks.

```{r brow_graph_hosp_counts, warning = FALSE}
ggplot(data = browardCOVID_df) +

	theme_bw() +
	theme(
		axis.text.x = element_text(angle = 45, hjust = 1),
		legend.position = "bottom"
	) +
	aes(x = Date, y = Count, group = Type, colour = Type) +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	scale_y_log10() +
	scale_color_manual(
		values = c(
			"Ventilated" = "#ff0000",
			"ICU" = "#ff7400",
			"Hospitalized" = "#ffc100"
		)
	) +
	labs(
		title = "Overall Broward County Hospital COVID-19 Census",
		subtitle = paste(
			"Broward County;",
			format(startEndESS_date[1], "%d %B"),
			"to",
			format(startEndESS_date[2], "%d %B"),
			"2020"
		),
		y = "Counts (Log10 Scale)"
	) +

	geom_point(size = 2) +
	stat_smooth(se = FALSE)
```

We also show the proportion of patients hospitalized which are in ICU and the proportion of those in ICU which are ventilated.
```{r brow_ICU_vent_props, warning=FALSE}
ggplot(
	data = browardHospitalised_df %>% 
		mutate(PctICU = 100 * ICU / Hospitalized) %>% 
		mutate(PctVentICU = 100 * Ventilated / ICU) %>% 
		select(Date, PctICU, PctVentICU) %>% 
		pivot_longer(
		PctICU:PctVentICU,
		names_to = "Type",
		values_to = "Proportion"
	)
) + 
	
	theme_bw() +
	theme(
		axis.text.x = element_text(angle = 45, hjust = 1),
		legend.position = "bottom"
	) +
	aes(x = Date, y = Proportion, group = Type, colour = Type) +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	scale_color_manual(
		labels = c("In ICU", "In ICU on Ventilators"),
		values = c(
			"PctVentICU" = "#ff0000",
			"PctICU" = "#ff7400"
		)
	) +
	labs(
		title = "Broward County Hospital Percent in ICU and Ventilated",
		subtitle = paste(
			"Broward County;",
			format(startEndESS_date[1], "%d %B"),
			"to",
			format(startEndESS_date[2], "%d %B"),
			"2020"
		),
		caption = 
			"% of Patients Hospitalized with COVID-19 who are in ICU (orange)\n % of Patients in ICU with COVID-19 who are on ventilators (red)",
		y = "Proportions"
	) +

	geom_point(size = 2) +
	stat_smooth(se = FALSE)
```

Overall, the percentage of COVID-19 hospitalized patients needing intensive care has decreased from over 35% in early April, to the current rate of below 25%. In addition, the percentage of COVID-19 ICU patients requiring ventilation decreased from over approximately 85% in early April, to under 40% currently. This decreasing trend has remained stable over the last three weeks.

*******************************************************************************




# Palm Beach County


## COVID-19 Testing Data
```{r pb_read_data}
pbCases_df <- read_csv(
	file = "../../data/FLDH_COVID19_cases_palmbeach_20200709.csv"
) %>% 
	mutate(PropPositive = 100 * Positive / (Positive + Negative)) %>% 
	mutate(PositivePer1k = (PropPositive / 100) * 1000)
```

```{r pb_fix_dates}
pbCases2_df <- 
	pbCases_df %>% 
	mutate(Date = as.POSIXct(strptime(Date, format = "%d-%b"))) %>% 
	mutate(Date = as_date(Date)) 
``` 

```{r pb_recent_data}
pbRecent_df <- 
	pbCases2_df %>% 
	top_n(15, Date)

# Recent Linear Trend Slope for Total Counts
pbRecentTCountSlope_num <-
	pbRecent_df %>% 
	lm(Positive + Negative ~ Date, data = .) %>% 
	coefficients() %>% 
	pluck(2)

# Recent Linear Trend Slope for Positive Counts
pbRecentPCountSlope_num <-
	pbRecent_df %>% 
	lm(Positive ~ Date, data = .) %>% 
	coefficients() %>% 
	pluck(2)

# Recent Linear Trend Slope
pbRecentSlope_num <-
	pbRecent_df %>% 
	lm(PropPositive ~ Date, data = .) %>% 
	coefficients() %>% 
	pluck(2)

# Slope Adjective:
pbAdjective <- case_when(
	abs(pbRecentSlope_num) < 0.1 ~ "slight",
	abs(pbRecentSlope_num) < 0.5 ~ "",
	abs(pbRecentSlope_num) > 0.5 ~ "significant"
)
```

### Full Data
```{r}
knitr::kable(pbCases_df) %>% 
	kable_styling() %>%
  scroll_box(height = "500px")
```

</br>


### Total COVID-19 Tests by Day
The average number of COVID-19 tests performed each day has increased from about 500 in early April to roughly 3000 in mid-June. Over the past two weeks, there has been an average increase of `r round(pbRecentTCountSlope_num)` new additional tests each day in Palm Beach County. This data is presented on a log scale.

```{r pb_tests_over_time, warning=FALSE}
nTotal_gg <- 
	ggplot(
		data = pbCases2_df %>%
			mutate(Total = Positive + Negative)
	) +
	
	theme_bw() +
	theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
	aes(x = Date, y = Total) + 
	scale_y_log10(
		breaks = c(2000, 5000, 10000),
		labels = c("2k", "5k", "10k")
	) +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	labs(
		title = "Number of COVID-19 Tests by Day",
		subtitle = paste(
			"Palm Beach County;",
			startEnd_date[1], "to", startEnd_date[2], "2020"
		),
		y = "Counts (Log10 Scale)"
	) +
	
	stat_smooth(method = "loess", colour = "black") +
  geom_point(colour = "black")

nTotal_gg
```

### Positive COVID-19 Tests by Day
There was a general decrease in the number of new positive test results from early April until around May 11th. Afterwards, this trend flattened out and then increased. Over the past two weeks, there has been an average increase of `r round(pbRecentPCountSlope_num)` new additional positive cases each day, per day in Palm Beach County.

```{r pb_cases_over_time, warning=FALSE}
nPositive_gg <- 
	ggplot(data = pbCases2_df) +
	
	theme_bw() +
	theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
	aes(x = Date, y = Positive) + 
	# scale_y_log10() +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	labs(
		title = "Number of Positive COVID-19 Tests Results by Day",
		subtitle = paste(
			"Palm Beach County;",
			startEnd_date[1], "to", startEnd_date[2], "2020"
		)
	) + 
	
	stat_smooth(method = "loess", colour = "green") +
	geom_point(colour = "green") 

nPositive_gg
```

### Proportion of Positive Cases within Past Two Weeks
During the 14-day period from `r recentStartEnd_date[1]` to `r recentStartEnd_date[2]`, there was a <b> `r pbAdjective` `r if (pbRecentSlope_num > 0) "increase" else "decrease"` </b> in the proportion of positive COVID-19 cases reported in Palm Beach County. Over this period, there was an average increase of `r round(pbRecentSlope_num, 1)` percentage points per day for new positive cases.

```{r pb_recent_proportion}
# Plot
ggplot(data = pbRecent_df) +
	
	theme_bw() +
	aes(x = Date, y = PropPositive) +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	labs(
		title = "Proportion of Positive Test Results within the Past Two Weeks",
		subtitle = paste(
			"Palm Beach County;",
			recentStartEnd_date[1], "to", recentStartEnd_date[2],
			"2020; Linear Change =",
			round(pbRecentSlope_num, 3)
		),
		caption = "Solid line: LOESS Predictor; Dashed line: Linear Predictor.",
		y = "Proportion (%) of Positive Cases"
	) +
	
	geom_point() +
	stat_smooth(method = "loess", colour = "black") +
	stat_smooth(method = "lm", colour = "black", se = FALSE, linetype = "dashed")
```

### Proportion of Positive COVID-19 Tests by Day
Overall, the proportion of positive test results out of all tests **decreased significantly** from over 15% in April to the proportion of about 6% at the end of May. This is function of test availability and the population being tested. Overall, since the county reopened, the proportion of positive tests is now increasing over time. Over the past two weeks the proportion of positive COVID-19 tests has increased by approximately 0.2% each day.

```{r pb_prop_over_time_full, warning=FALSE}
ggplot(data = pbCases2_df) +
	
	theme_bw() +
	theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
	aes(x = Date, y = PropPositive) +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	labs(
		title = "Overall Proportion of Positive Test Results Out of All Tests",
		subtitle = paste(
			"Palm Beach County;",
			startEnd_date[1], "to", startEnd_date[2], "2020"
		),
		caption = "Solid line: LOESS Predictor",
		y = "Proportion (%) of Positive Cases"
	) +
	
	geom_point() +
	stat_smooth(method = "loess", colour = "orange")
```


## COVID-19 Hospitalization Data
```{r pb_hosp_data}
palmbeachHospitalised_df <- 
	southFloridaHospitalised_df %>% 
	filter(County == "PALM BEACH")

palmbeachCOVID_df <-
	palmbeachHospitalised_df %>%
	select(-County, -AdmitPrevDay, -DischPrevDay, -DeltaAdmit) %>% 
	pivot_longer(
		Hospitalized:Ventilated,
		names_to = "Type",
		values_to = "Count"
	)
```

### Full Data

```{r pb_print_hosp_data}
palmbeachHospitalised_df %>% 
  knitr::kable() %>% 
	kable_styling() %>%
  scroll_box(height = "500px")
```

</br>


### Hospital COVID-19 Census Trajectory
We now show a census plot of hospitalizations, patients in ICU, and those in ICU on ventilators (shown on a log scale) for Palm Beach County. Overall, in Palm Beach County, trends for hospitalization census, ICU census and ventilation census decreased from April to mid May before reversing. Subsequently, we see an increase in hospitalization census, ICU census, and ventilation census for Palm Beach County. The COVID-19 ICU census has decreased from its reported peak of 103 on April 12th to 55 on May 23rd; currently there are `r palmbeachHospitalised_df$ICU[nrow(palmbeachHospitalised_df)]` COVID-19 patients in ICU. Overall, the number of COVID-19 patients on ventilators has decreased significantly from its highest point of 75 ventilated on April 4th to to 33 on May 18th; currently there are `r palmbeachHospitalised_df$Ventilated[nrow(palmbeachHospitalised_df)]` COVID-19 patients in ICU who are on ventilators. **However, the observed flat trend for hospitalization, ICU, and ventilated census have reversed over the past month and began to increase.** 

```{r pb_graph_hosp_counts, warning = FALSE}
ggplot(data = palmbeachCOVID_df) +

	theme_bw() +
	theme(
		axis.text.x = element_text(angle = 45, hjust = 1),
		legend.position = "bottom"
	) +
	aes(x = Date, y = Count, group = Type, colour = Type) +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	scale_y_log10() +
	scale_color_manual(
		values = c(
			"Ventilated" = "#ff0000",
			"ICU" = "#ff7400",
			"Hospitalized" = "#ffc100"
		)
	) +
	labs(
		title = "Overall Palm Beach County Hospital COVID-19 Census",
		subtitle = paste(
			"Palm Beach County;",
			format(startEndESS_date[1], "%d %B"),
			"to",
			format(startEndESS_date[2], "%d %B"),
			"2020"
		),
		y = "Counts (Log10 Scale)"
	) +

	geom_point(size = 2) +
	stat_smooth(se = FALSE)
```

We also show the proportion of patients hospitalized which are in ICU and the proportion of those in ICU which are ventilated.
```{r pb_ICU_vent_props, warning=FALSE}
ggplot(
	data = palmbeachHospitalised_df %>% 
		mutate(PctICU = 100 * ICU / Hospitalized) %>% 
		mutate(PctVentICU = 100 * Ventilated / ICU) %>% 
		select(Date, PctICU, PctVentICU) %>% 
		pivot_longer(
		PctICU:PctVentICU,
		names_to = "Type",
		values_to = "Proportion"
	)
) + 
	
	theme_bw() +
	theme(
		axis.text.x = element_text(angle = 45, hjust = 1),
		legend.position = "bottom"
	) +
	aes(x = Date, y = Proportion, group = Type, colour = Type) +
	scale_x_date(
		date_breaks = "1 week",
		date_minor_breaks = "1 day",
		labels = scales::date_format("%d-%b")
	) +
	scale_color_manual(
		labels = c("In ICU", "In ICU on Ventilators"),
		values = c(
			"PctVentICU" = "#ff0000",
			"PctICU" = "#ff7400"
		)
	) +
	labs(
		title = "Palm Beach County Hospital Percent in ICU and Ventilated",
		subtitle = paste(
			"Palm Beach County;",
			format(startEndESS_date[1], "%d %B"),
			"to",
			format(startEndESS_date[2], "%d %B"),
			"2020"
		),
		caption = 
			"% of Patients Hospitalized with COVID-19 who are in ICU (orange)\n % of Patients in ICU with COVID-19 who are on ventilators (red)",
		y = "Proportions"
	) +

	geom_point(size = 2) +
	stat_smooth(se = FALSE)
```

Overall, the percentage of COVID-19 hospitalized patients requiring intensive care has decreased from  approximately 50% in early April to the current rate of approximately 20%. Over the past two weeks, this decreasing trend appears to have continued. Additionally, the percentage of patients in the ICU on ventilation has decreased from 80% in early April to the current percentage of approximately 60%. The initial decreasing trend from early April to mid May has reversed over the past three weeks and begun to increase slightly for Palm Beach County.

*******************************************************************************




# Conclusion
During the past two weeks, the number of positive COVID-19 tests has increased by an average of `r round(mdRecentPCountSlope_num)`, `r round(browRecentPCountSlope_num)`, and `r round(pbRecentPCountSlope_num)` each day for Miami-Dade, Broward, and Palm Beach Counties, respectively. Additionally, there has been a substantial increase in the proportion of positive COVID-19 tests obtained within the past two weeks. Furthermore, hospitalization census, ICU census, and ventilation census for Miami-Dade County have all begun to increase over approximately the last three weeks. **Taken together, this evidence points to increased community spread of COVID-19 in Miami-Dade County and represents a significant concern for the area.** For Broward County, the number of people in the hospital and in intensive care units have increased since the beginning of June; the number of people on ventilation has begun to increase as well. Finally, for Palm Beach County, hospitalization census, ICU census and ventilation census have all increased consistently since approximately mid May.


*******************************************************************************




# Data Sources
Data sources are as follows:

- **COVID-19 Test Results**: The number of positive and negative COVID-19 test results come from the Florida Department of Health: https://floridahealthcovid19.gov/.
- **COVID-19 Hospital Census**: The hospitalization data is disseminated by Florida’s Agency for Health Care Administration: https://ahca.myflorida.com/.
